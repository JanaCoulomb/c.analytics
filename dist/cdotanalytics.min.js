//used this as a inspiration: https://stackoverflow.com/questions/17804078/is-it-possible-to-know-how-long-a-user-has-spent-on-a-page

var cdotanalytics_start_focus_time = undefined;
var cdotanalytics_last_user_interaction = undefined;

const cdotanalytics_optout_storage_string = "cdotanalytics_optout";
const cdotanalytics_serverDeleteAnalyticsUrl = document.currentScript.dataset.serveranalyticsbaseurl + "/recieveAnalyticsDeleteRequest";
const cdotanalytics_serverAnalyticsUrl = document.currentScript.dataset.serveranalyticsbaseurl + "/recieveAnalyticsData";



function cdotanalytics_focus_check() {
        if (cdotanalytics_start_focus_time != undefined) {
            var curr_time = new Date();
            //Lets just put it for 4.5 minutes                                                                                
        if((curr_time.getTime() - cdotanalytics_last_user_interaction.getTime()) > (270 * 1000)) {
                //No interaction in this tab for last 5 minutes. Probably idle.                                               
                cdotanalytics_window_unfocused();
            }
        }
}

function cdotanalytics_window_focused() {
        cdotanalytics_last_user_interaction = new Date();
        if (cdotanalytics_start_focus_time == undefined) {
            cdotanalytics_start_focus_time = new Date();                                                               
        }
}

function cdotanalytics_window_unfocused() {
        if (cdotanalytics_start_focus_time != undefined) {
            var cdotanalytics_stop_focus_time = new Date();
            var cdotanalytics_total_focus_time = cdotanalytics_stop_focus_time.getTime() - cdotanalytics_start_focus_time.getTime();
            cdotanalytics_start_focus_time = undefined;

            
            
            const body = {"siteTitle":document.title,"totalTime":cdotanalytics_total_focus_time};
              const headers = {
                type: 'application/json',
              };
              const blob = new Blob([JSON.stringify(body)], headers);             
            navigator.sendBeacon(cdotanalytics_serverAnalyticsUrl, blob)
        }
}

function init() {
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            cdotanalytics_window_focused();
        } else {
            cdotanalytics_window_unfocused();
        }
      });
      document.addEventListener("focus", () => {
        cdotanalytics_window_focused();
      });
      document.addEventListener("blur", () => {
        cdotanalytics_window_unfocused();
      });
      setInterval(cdotanalytics_focus_check, 300 * 1000);

      

}

if(cdotanalytics_isoptin())
    init();

function cdotanalytics_isoptin() {
    return (localStorage.getItem(cdotanalytics_optout_storage_string) != true);
}

function cdotanalytics_optin() {
    localStorage.setItem(cdotanalytics_optout_storage_string,false); 
    window.location.reload();
}
function cdotanalytics_optout() {
    localStorage.setItem(cdotanalytics_optout_storage_string,true); 

   
    navigator.sendBeacon(cdotanalytics_serverDeleteAnalyticsUrl)
    window.location.reload();
}
function cdotanalytics_opttoggle() {
    if(cdotanalytics_isoptin())
        cdotanalytics_optout();
    else    
        cdotanalytics_optin();
}


